# 灵境产品维护文档

## 部署服务器

### 部署主机

| 本地IP        | 需要打通的IP   | 需要打通的端口 |
| ------------- | -------------- | -------------- |
| 10.31.100.149 | 120.202.17.100 | 13589          |
| 10.31.100.157 | 120.202.17.100 | 13589          |
| 10.31.100.158 | 120.202.17.100 | 13589          |

### 部署目录

## Mysql服务器

### Mysql主机信息

```shell
ssh ocdc@10.29.31.247
.1Uo#3Px(4
```

### Mysql连接信息

```shell
mysql -uroot -h10.29.31.244 -P32111 -pplle373medlzzvwo7vme

password : plle373medlzzvwo7vme
uri : external address: 10.29.31.244:32111, internal address: sb-wejcfx6pob3rk-mariadb.service-brokers.svc.cluster.local:3306
username : root
status : Unbound
```

### 数据库相关脚本

```mysql
## 创建数据库
create database smart default charset utf8;
## 使用数据库
use smart;
-- auto-generated definition
## 创建表
create table st_smart_webchat_unbundl_hm
(
  chg_sn         varchar(255) not null
  comment '变更流水号'
    primary key,
  chg_org_id     varchar(255) null
  comment '变更组织机构标识',
  phone_no       varchar(255) null
  comment '电话号码',
  send_flag      varchar(255) null
  comment '发送标记',
  stat_date      varchar(255) null
  comment '统计日',
  stat_hour      varchar(255) null
  comment '统计小时',
  stat_month     varchar(255) null
  comment '统计月',
  state_chg_time varchar(255) null
  comment '用户状态变更时间',
  user_id        varchar(255) null
  comment '用户标识',
  user_state     varchar(255) null
  comment '用户变更状态:1：销户:2：过户:3：携出'
)
  comment '灵镜微信解绑用户小时表';


-- auto-generated definition
create table st_smart_webchat_unbundl_send
(
  chg_sn         varchar(255) not null
  comment '变更流水号'
    primary key,
  chg_org_id     varchar(255) null
  comment '变更组织机构标识',
  phone_no       varchar(255) null
  comment '电话号码',
  send_flag      varchar(255) null
  comment '发送标记',
  stat_date      varchar(255) null
  comment '统计日',
  stat_hour      varchar(255) null
  comment '统计小时',
  stat_month     varchar(255) null
  comment '统计月',
  state_chg_time varchar(255) null
  comment '用户状态变更时间',
  user_id        varchar(255) null
  comment '用户标识',
  user_state     varchar(255) null
  comment '用户变更状态:1：销户:2：过户:3：携出'
)
  comment '灵镜微信解绑用户小时表发送表';
```





## 变更状态

```java
US24 强制退网
US20 正式销户
US63 携号转网转出
:1：销户:2：过户:3：携出
0：自主解绑；1：绑定；2：重新绑定；3：强制解绑    

```



### 测试数据获取脚本

> dacp->数据查询(数据中心团队) -->数据中心数据库

```sql

select 
concat('insert into st_smart_webchat_unbundl_hm(chg_sn,user_id,phone_no,user_state,state_chg_time,chg_org_id,send_flag,stat_month,stat_date,stat_hour) values (\'',
       CONCAT_WS('\',\'', p1.chg_sn
 ,substr(p1.user_id,1,20)
,p2.servnumber
,p1.user_state
,substr(p1.state_chg_time,1,19)
,p1.chg_org_id
,substr(p1.send_flag,1,1)
,p1.stat_month
,p1.stat_date
,p1.stat_hour ),'\');')
from DW_USR_SMART_WECHAT_UNBIND_HM P1
left join (select subsid,servnumber from odss01_subscriber_dm  where day_id ='20181224') P2
on P1.user_id =p2.subsid
where stat_date ='20181224'
```

### Mysql数据导出

```sql
mysqldump -udacp_smart -P32111 -h10.29.31.244 -p smart st_smart_webchat_unbundl_hm> st_smart_webchat_unbundl_hm.sql

mysql -udacp_smart -h10.29.31.244 -p'dacp_smart_!@#$' -P32111  # 密码有特殊字符需要加''

```

